import{r as f,j as e,u as q,a as P}from"./client-CJnX4qAx.js";import{u as z,D as B,F as c,a as d,b as h,c as u,I,d as m,S,e as $,f as D,g as E,h as v,L as W,i as R,B as U}from"./index-BUtqJqcX.js";import{S as Z}from"./Sidebar-BAhWtxfF.js";import{P as G}from"./plus-CgB9mJF2.js";const H=async(l,t)=>{const p=await fetch(`/api/configuration/${l}/${t}/versions`);if(!p.ok)throw new Error(`API antwortete mit Status: ${p.status}`);return p.json()},J=({refetch:l,configurations:t,versions:p,onAddDeployment:k,owner:T})=>{const[A,V]=f.useState([]),[x,F]=f.useState(!1),[L,y]=f.useState(null),[N,b]=f.useState(null),a=z({defaultValues:{name:"",label:"",description:"",configuration:"",configurationVersion:"",template:"",templateVersion:"",flow:"",size:""}}),w=a.watch("configuration");a.watch("template"),f.useEffect(()=>{async function n(){if(!w){V([]);return}try{F(!0);const r=t.find(s=>s.name===w);if(!r||!r.owner)throw new Error("Configuration owner could not be found");const o=await H(r.owner,r.name);V(o),a.setValue("configurationVersion","")}catch(r){console.error("Error loading configuration versions:",r),V([])}finally{F(!1)}}n()},[w,t,a]);const O=async n=>{try{b(null),y(null);let r={...n};if(r.owner=T,n.configuration&&n.configurationVersion){const s=n.configuration,i=n.configurationVersion,j=n.version==="main";r.configurations=[{name:s,version:i,main:j}],delete r.configuration,delete r.configurationVersion}if(n.template&&n.templateVersion){const s=n.template,i=n.templateVersion,j=n.version==="main";r.template={name:s,version:i,main:j},delete r.templateVersion}const o=await fetch("/api/deployment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok){const s=await o.json();throw new Error(s.error||"Error creating the deployment")}y("Deployment was successfully created!"),setTimeout(()=>{y(null)},5e3),l(),a.reset()}catch(r){console.error("Fehler:",r),b(r.message),setTimeout(()=>{b(null)},5e3)}};return e.jsx("div",{children:e.jsxs(B,{trigger:"Add",triggerIcon:G,title:"Add Deployment",description:"Fill out the following fields to create a new deployment.",applyAction:O,applyTitle:"Submit",closeTitle:"Cancel",hookForm:a,onClose:()=>k(),className:"max-h-[95vh] overflow-y-scroll",children:[N&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:[e.jsx("strong",{children:"Fehler:"})," ",N]}),L&&e.jsxs("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4",children:[e.jsx("strong",{children:"Erfolg:"})," ",L]}),e.jsx(c,{control:a.control,name:"name",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Name"}),e.jsx(u,{children:e.jsx(I,{...n})}),e.jsx(m,{})]})}),e.jsx(c,{control:a.control,name:"label",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Label"}),e.jsx(u,{children:e.jsx(I,{...n})}),e.jsx(m,{})]})}),e.jsx(c,{control:a.control,name:"description",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Description"}),e.jsx(u,{children:e.jsx(I,{...n})}),e.jsx(m,{})]})}),e.jsx(c,{control:a.control,name:"flow",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Flow"}),e.jsx(u,{children:e.jsx(I,{...n})}),e.jsx(m,{})]})}),e.jsx(c,{control:a.control,name:"configuration",render:({field:n})=>{const r=t.map(o=>({value:`${o.name}`,label:`${o.name}`}));return e.jsxs(d,{children:[e.jsx(h,{children:"Configuration"}),e.jsxs(S,{onValueChange:n.onChange,value:n.value,children:[e.jsx(u,{children:e.jsx($,{children:e.jsx(D,{placeholder:"Wähle eine Konfiguration"})})}),e.jsx(E,{children:r.map(o=>e.jsx(v,{value:o.value,children:o.label},o.value))})]}),e.jsx(m,{})]})}}),e.jsx(c,{control:a.control,name:"configurationVersion",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Configuration-Version"}),e.jsxs(S,{onValueChange:n.onChange,value:n.value,disabled:!w||x,children:[e.jsx(u,{children:e.jsx($,{children:e.jsx(D,{placeholder:x?"Lade Versionen...":w?"Wähle eine Konfigurations-Version":"Zuerst Konfiguration auswählen"})})}),e.jsx(E,{children:A.length>0&&A.map((r,o)=>e.jsx(v,{value:r,children:r},o))})]}),e.jsx(m,{})]})}),e.jsx(c,{control:a.control,name:"template",render:({field:n})=>{const r=Object.keys(p).map(o=>({value:o,label:o}));return e.jsxs(d,{children:[e.jsx(h,{children:"Template"}),e.jsxs(S,{onValueChange:n.onChange,value:n.value,children:[e.jsx(u,{children:e.jsx($,{children:e.jsx(D,{placeholder:"Wähle ein Template"})})}),e.jsx(E,{children:r.map(o=>e.jsx(v,{value:o.value,children:o.label},o.value))})]}),e.jsx(m,{})]})}}),e.jsx(c,{control:a.control,name:"templateVersion",render:({field:n})=>{const r=a.watch("template"),o=p[r]||[];return e.jsxs(d,{children:[e.jsx(h,{children:"Template-Version"}),e.jsxs(S,{onValueChange:n.onChange,value:n.value,disabled:!r,children:[e.jsx(u,{children:e.jsx($,{children:e.jsx(D,{placeholder:r?"Wähle eine Template-Version":"Zuerst Template auswählen"})})}),e.jsx(E,{children:o.map((s,i)=>e.jsx(v,{value:s,children:s},i))})]}),e.jsx(m,{})]})}}),e.jsx(c,{control:a.control,name:"size",render:({field:n})=>e.jsxs(d,{children:[e.jsx(h,{children:"Size"}),e.jsxs(S,{onValueChange:n.onChange,value:n.value,children:[e.jsx(u,{children:e.jsx($,{children:e.jsx(D,{placeholder:"Wähle eine Größe"})})}),e.jsxs(E,{children:[e.jsx(v,{value:"S",children:"S"}),e.jsx(v,{value:"M",children:"M"}),e.jsx(v,{value:"L",children:"L"})]})]}),e.jsx(m,{})]})})]})})},Q=async l=>{const t=await fetch(`/api/deployment/${l}`);if(!t.ok)throw new Error(`API antwortete mit Status: ${t.status}`);return t.json()},X=async l=>{const t=await fetch(`/api/configuration/${l}`);if(!t.ok)throw new Error(`API antwortete mit Status: ${t.status}`);return t.json()},Y=async l=>{const t=await fetch(`/api/template/${l}/versions`);if(!t.ok)throw new Error(`API antwortete mit Status: ${t.status}`);return await t.json()},re=function(){const{owner:t,isLoadingSettings:p,settingsError:k}=q(),T=f.useRef(null),[A,V]=f.useState({}),{data:x=[],isLoading:F,error:L,refetch:y}=P({queryKey:["deployments",t],queryFn:()=>Q(t)}),{data:N=[],isLoading:b,error:a,refetch:w}=P({queryKey:["configurations",t],queryFn:()=>X(t)});f.useEffect(()=>{(async()=>{if(x.length===0)return;const i=Array.from(new Set(x.map(g=>g.template))),j={};for(const g of i)try{const C=await Y(g);j[g]=C}catch(C){console.error(`Fehler beim Abrufen der Template-Versionen für ID ${g}:`,C)}V(j)})()},[x]);const O=()=>{T.current?.scrollIntoView({behavior:"smooth"})},n=async()=>{try{setTimeout(()=>{O()},200)}catch(s){console.error("Fehler:",s)}},r=b||F||p,o=a||L||k;return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4",children:e.jsx(Z,{children:e.jsxs("div",{className:"mt-8 mb-8 mr-4",children:[e.jsx("div",{className:"mb-9",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Deployments:"}),e.jsx(J,{refetch:y,configurations:N,versions:A,onAddDeployment:n,owner:t})]})}),r?e.jsx("p",{children:"Lade Daten..."}):o?e.jsx("p",{className:"text-red-500",children:o.message}):e.jsxs("div",{children:[x.length>0&&x.map(s=>{const i=s.envs[0]&&s.envs[0].versions&&s.envs[0].versions.components.length>0?s.envs[0].versions.components.map(M=>`${M.name} ${M.version}`).join(", "):"Keine Version verfügbar",j=s.envs[0]&&s.envs[0].state?s.envs[0].state.tests:"NONE",g=s.envs[0]&&s.envs[0].state?s.envs[0].state.apis:"0",C=s.envs[0]&&s.envs[0].state?s.envs[0].state.health:"UNAVAILABLE",K=s.envs[0]&&s.envs[0].state?s.envs[0].state.url:"UNAVAILABLE";return e.jsx("div",{className:"mb-4",children:e.jsx(W,{to:"/deployment/$owner/$name",params:{owner:s.owner,name:s.name},className:"block no-underline",children:e.jsx(R,{title:`${s.label}`,description:`${s.description}`,state:`${C}`,apis:`${g}`,size:`${s.size}`,tests:`${j}`,version:i,href:`${K}`})})},s.name)}),e.jsx("div",{})]}),e.jsx(U,{onClick:()=>y(),className:"mt-4",variant:"outline",children:"Daten aktualisieren"}),e.jsx("div",{ref:T})]})})})};export{re as component};
